---
phase: 05-verification
plan: "02"
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - .planning/phases/05-verification/05-VERIFICATION.md
  - app/api/demo-call/route.ts
  - components/sections/DemoForm.tsx
  - lib/rate-limit/demo-call.ts
autonomous: false
requirements:
  - SEC-02
  - SEC-03
  - SEC-04
  - SEC-05
  - FORM-01
  - FORM-02
  - UX-01
  - UX-02
  - UX-03
  - UX-04
  - INFR-01
  - INFR-02
  - INFR-03
  - AGNT-01
  - AGNT-02
  - AGNT-03
  - AGNT-04
  - AGNT-05
must_haves:
  truths:
    - "A real test call initiated through the browser form terminates at or before 120 seconds from connection"
    - "Submitting the form twice with the same phone number from the same IP: the second request shows a 429 error in the UI and no second call is placed"
    - "Entering a Canadian phone number (416 area code) shows a validation error and no call is placed"
    - "Loading spinner, success state, rate-limit error, and button disabled state all render correctly in the browser"
    - "All five tests in VERIFICATION.md have pass results recorded with timestamps"
  artifacts:
    - path: ".planning/phases/05-verification/05-VERIFICATION.md"
      provides: "Complete verification checklist with all tests passed"
  key_links:
    - from: "components/sections/DemoForm.tsx"
      to: "/api/demo-call"
      via: "fetch POST on form submit"
      pattern: "fetch.*api/demo-call"
    - from: "app/api/demo-call/route.ts"
      to: "lib/rate-limit/demo-call.ts"
      via: "rate limit check before Retell call"
      pattern: "ipRatelimit|phoneRatelimit"
    - from: "app/api/demo-call/route.ts"
      to: "lib/retell/client.ts"
      via: "outbound call creation"
      pattern: "retellClient.*create"
---

<objective>
Execute all browser-based verification tests against the production build on localhost. Start the production server, walk through each test in order, record results in VERIFICATION.md, and fix any failures directly.

Purpose: Prove that security controls (rate limiting, phone validation, call duration cap) and UX states (loading, success, error, button disabled) actually work in production — not just in code.

Output: `.planning/phases/05-verification/05-VERIFICATION.md` fully completed with all tests passed.
</objective>

<execution_context>
@C:/Users/DESKTOP/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/DESKTOP/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-verification/05-RESEARCH.md
@.planning/phases/05-verification/05-01-SUMMARY.md
@app/api/demo-call/route.ts
@components/sections/DemoForm.tsx
@lib/rate-limit/demo-call.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Start production server and prepare test environment</name>
  <files></files>
  <action>
Start the production server from the existing build (Plan 01 already ran `npm run build`):

```bash
npm start
```

This runs `next start` which serves the production build at http://localhost:3000.

Verify the server is accessible:
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000
```
Expected: 200.

Update VERIFICATION.md to check the "Production server running" prerequisite checkbox.

Leave the server running for the human verification checkpoint.
  </action>
  <verify>
`curl http://localhost:3000` returns HTTP 200.
  </verify>
  <done>Production server running at localhost:3000, accessible and serving the homepage with the demo form</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Execute manual verification tests in browser</name>
  <files>.planning/phases/05-verification/05-VERIFICATION.md</files>
  <action>
Human verification of the complete demo system against the production build at http://localhost:3000.

What was built (Phases 1-4):
- POST /api/demo-call route with rate limiting (IP + phone, 1 per 10 min), phone validation (US-only via libphonenumber-js), and call duration cap (120s via agent_override)
- DemoForm on homepage with loading spinner, success state, rate-limit error, and button disabled states
- VERIFICATION.md created with Test 1 (key-leak) already completed

Tests 2-5 require browser interaction and a real phone to receive calls. Execute in order:

**Test 2: Call Duration Cap (SEC-04)**
1. Scroll to the demo form on the homepage
2. Enter your real name, a US phone number, and email
3. Click submit — observe the loading spinner (UX-01) and button becoming disabled (UX-04)
4. When your phone rings, start a stopwatch
5. Answer and wait silently
6. Record the time when the call auto-disconnects
7. PASS if call ends at or before ~125 seconds (120s cap + 5s tolerance)
8. After success, observe the success state ("Your call is on its way" with CTA) (UX-02)

**Test 3: Rate Limit (SEC-02, SEC-03, UX-03)**
1. With the same browser session (same IP), enter the SAME phone number in the form
2. Submit again
3. PASS if: the form shows a rate-limit error message AND no second phone call is received

**Test 4: Non-US Phone Validation (FORM-02)**
1. Enter a Canadian phone number with a 416 area code (e.g., 4165550100)
2. Submit
3. PASS if: a phone validation error appears AND no call is placed

**Test 5: UX States Summary**
Confirm you observed all four states during tests 2-4:
- Loading spinner during submission (Test 2)
- Success card after call triggered (Test 2)
- Rate-limit error message (Test 3)
- Submit button disabled during API call (Test 2)

Report format: For each test, report PASS or FAIL + brief note. If any test fails, describe what you saw — the executor will fix the issue and retest (max 3 attempts per test).
  </action>
  <verify>
Human reports PASS for all four tests (Tests 2-5) or failures are fixed and retested successfully.
  </verify>
  <done>All browser-based tests pass: call terminates within 120s, rate limit returns 429, Canadian phone rejected, all UX states render correctly</done>
</task>

<task type="auto">
  <name>Task 3: Record final results in VERIFICATION.md and stop server</name>
  <files>.planning/phases/05-verification/05-VERIFICATION.md</files>
  <action>
After human verification completes (all tests pass or failures are fixed and retested):

1. Update VERIFICATION.md with the human-reported results:
   - Fill in all Test 2-5 checkbox rows with pass/fail, timestamps, and environment
   - Fill in the Summary table with final results
   - If any failures occurred and were fixed, record in the Failure Log section: test name, failure description, fix applied, retest result

2. Stop the production server (Ctrl+C or kill the process).

3. Verify the completed VERIFICATION.md has:
   - All 5 tests with pass results
   - All timestamps filled in
   - Summary table complete
   - No empty checkboxes remaining in test result rows

If any test failed 3 times without resolution, note it in the Failure Log as "needs architectural review" per CONTEXT.md decision.
  </action>
  <verify>
All test rows in VERIFICATION.md have pass/fail values (no empty checkboxes in result columns).
Summary table shows all 5 tests with results.
  </verify>
  <done>VERIFICATION.md is fully completed with all tests passed (or failures documented per the 3-retry protocol). Phase 5 verification is done.</done>
</task>

</tasks>

<verification>
1. Production server starts and serves localhost:3000
2. Human confirms: real call terminates within 120s (+5s tolerance) of connection
3. Human confirms: second submit shows 429 error, no second call
4. Human confirms: Canadian phone number shows validation error, no call
5. Human confirms: all four UX states rendered correctly
6. VERIFICATION.md fully completed with all results and timestamps
</verification>

<success_criteria>
- All 5 verification tests pass (or are fixed and pass on retest)
- VERIFICATION.md is complete with pass results, timestamps, and environment for every test row
- No empty checkboxes remain in test result columns
- Phase 5 success criteria from ROADMAP.md are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification/05-02-SUMMARY.md`
</output>
