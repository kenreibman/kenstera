---
phase: 04-form-ui
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - app/layout.tsx
  - components/sections/DemoForm.tsx
autonomous: true
requirements: [FORM-01, FORM-02, FORM-03, UX-01, UX-02, UX-03, UX-04]

user_setup:
  - service: google-recaptcha
    why: "reCAPTCHA v3 client-side token generation"
    env_vars:
      - name: NEXT_PUBLIC_RECAPTCHA_SITE_KEY
        source: "Google reCAPTCHA Admin Console -> Register site -> Copy Site Key. For local dev use Google test key: 6LeIxAcTAAAAAJcZVRqyHh71UMIEGNQ_MXjiZKhI"

must_haves:
  truths:
    - "DemoForm component renders name, phone, and email fields on a #00122e dark background"
    - "Phone field auto-formats as (XXX) XXX-XXXX while the user types"
    - "Submitting valid fields calls /api/demo-call with name, phone, email, and recaptchaToken"
    - "Form transitions to a success state showing 'Your call is on its way' with a 'Book a sales call' CTA"
    - "Rate limit (429) shows a distinct retry-later message, not a generic error"
    - "Submit button is disabled after first click and cannot trigger double submission"
    - "reCAPTCHA v3 token is generated invisibly at submit time (not on mount)"
  artifacts:
    - path: "components/sections/DemoForm.tsx"
      provides: "Complete demo form component with four form states"
      min_lines: 120
    - path: "app/layout.tsx"
      provides: "ReCaptchaProvider wrapping LayoutWrapper"
      contains: "ReCaptchaProvider"
  key_links:
    - from: "components/sections/DemoForm.tsx"
      to: "/api/demo-call"
      via: "fetch POST in handleSubmit"
      pattern: "fetch.*api/demo-call"
    - from: "components/sections/DemoForm.tsx"
      to: "next-recaptcha-v3"
      via: "useReCaptcha hook"
      pattern: "executeRecaptcha"
    - from: "app/layout.tsx"
      to: "next-recaptcha-v3"
      via: "ReCaptchaProvider component"
      pattern: "ReCaptchaProvider"
---

<objective>
Install next-recaptcha-v3, add the ReCaptchaProvider to the root layout, and build the complete DemoForm.tsx section component with all four form states (idle, submitting, success, error), phone auto-formatting, reCAPTCHA v3 invisible verification, and status-code-driven error handling.

Purpose: Delivers the entire client-side form UI that visitors interact with. The API route already exists from Phase 2 — this plan builds the frontend that calls it.
Output: A fully functional DemoForm section component and reCAPTCHA provider integration.
</objective>

<execution_context>
@C:/Users/DESKTOP/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/DESKTOP/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-form-ui/04-CONTEXT.md
@.planning/phases/04-form-ui/04-RESEARCH.md
@.planning/phases/02-secure-api-route/02-01-SUMMARY.md

# Existing files to reference for patterns and insertion points
@app/layout.tsx
@app/api/demo-call/route.ts
@components/sections/IntakeCall.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-recaptcha-v3 and add ReCaptchaProvider to layout</name>
  <files>
    package.json
    package-lock.json
    app/layout.tsx
  </files>
  <action>
1. Install the reCAPTCHA library:
   ```bash
   npm install next-recaptcha-v3
   ```

2. Modify `app/layout.tsx` to wrap `LayoutWrapper` inside `ReCaptchaProvider`:
   - Add import: `import { ReCaptchaProvider } from 'next-recaptcha-v3'`
   - Wrap `<LayoutWrapper>{children}</LayoutWrapper>` with:
     ```tsx
     <ReCaptchaProvider reCaptchaKey={process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}>
       <LayoutWrapper>{children}</LayoutWrapper>
     </ReCaptchaProvider>
     ```
   - layout.tsx stays a server component (no 'use client' needed — ReCaptchaProvider is a client component rendered as a leaf, which is valid in Next.js App Router)
   - Do NOT move Analytics, SpeedInsights, or the Meta Pixel Script inside the provider — they remain siblings after the provider

3. Verify: `npm run build` completes without errors. The provider will receive `undefined` for the key at build time if NEXT_PUBLIC_RECAPTCHA_SITE_KEY is not set — this is expected and does not cause a build failure.
  </action>
  <verify>
    Run `npm run build` — must exit 0 with no type errors.
    Confirm `npm ls next-recaptcha-v3` shows the installed version.
    Confirm layout.tsx contains ReCaptchaProvider wrapping LayoutWrapper.
  </verify>
  <done>
    next-recaptcha-v3 is installed, ReCaptchaProvider wraps LayoutWrapper in layout.tsx, build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build DemoForm.tsx section component with all form states</name>
  <files>
    components/sections/DemoForm.tsx
  </files>
  <action>
Create `components/sections/DemoForm.tsx` as a `'use client'` component implementing all FORM and UX requirements. Follow existing section component patterns (IntakeCall.tsx, CRMIntegrations.tsx).

**Imports:**
- `useState`, `useCallback`, `useRef` from react
- `motion`, `AnimatePresence` from framer-motion
- `useReCaptcha` from next-recaptcha-v3
- `AsYouType` from libphonenumber-js
- `Link` from next/link
- `Loader2`, `CheckCircle` from lucide-react

**Form state machine:**
- Single `FormState` type: `'idle' | 'submitting' | 'success' | 'error'`
- `formState` drives all UI: button disabled state, spinner, content swap
- `fieldErrors` as `Record<string, string>` for inline validation errors
- `globalError` as `string | null` for rate limit and API failure messages
- `isSubmitting` useRef guard to prevent race condition double-submit (in addition to disabled button)

**Form state: 'error'**
- On error, set `formState` back to `'error'` which should re-enable the submit button (UX-04: button disabled only during `submitting`, re-enabled on `error` so user can retry)
- Actually — per CONTEXT.md, "disabled after first click to prevent double submission" and UX-04 spec. The research clarifies: `disabled` when `formState !== 'idle'`, but cleared on error recovery. So `formState === 'error'` should re-enable the button. Implement: `disabled={formState === 'submitting'}` (disabled only while submitting; enabled at idle and error).

**Phone auto-format (FORM-02):**
- `phoneDisplay` state for the formatted display value
- On change: strip non-digits, feed through `new AsYouType('US').input(digits)`, set display
- Send the display value in the POST body — the server's `parsePhoneNumberFromString(phone, 'US')` normalizes either format to E.164
- Limit input to 10 digits (US numbers) — after stripping non-digits, truncate to 10 chars before formatting

**reCAPTCHA integration (FORM-03):**
- Call `executeRecaptcha('demo_call')` inside `handleSubmit`, immediately before the fetch call
- Include the token as `recaptchaToken` in the POST JSON body
- Do NOT call executeRecaptcha on mount or in useEffect (tokens expire after 2 minutes)

**Submit handler:**
```
1. Prevent default, check isSubmitting guard
2. Set isSubmitting.current = true, formState = 'submitting', clear errors
3. Client-side validation: name not empty, phone has 10 digits, email contains @
4. If validation fails: set fieldErrors, formState = 'error', clear guard, return
5. Get reCAPTCHA token via executeRecaptcha('demo_call')
6. POST to /api/demo-call with { name, phone: phoneDisplay, email, recaptchaToken }
7. Parse response JSON
8. If !res.ok:
   - 429: setGlobalError('You have already requested a demo call recently. Please try again in 10 minutes.')
   - 400: setFieldErrors({ phone: data.error })
   - else: setGlobalError(data.error ?? 'Something went wrong. Please try again.')
   - Set formState = 'error', clear isSubmitting guard, return
9. On success: setFormState('success')
```

**Layout (per CONTEXT.md locked decisions):**
- Full-width section with `style={{ backgroundColor: '#00122e' }}` (user-specified deep navy)
- `py-20 md:py-28` vertical padding (matches IntakeCall.tsx pattern)
- Inner container: `w-full max-w-7xl mx-auto px-5` (matches IntakeCall.tsx pattern)
- Two-column grid on desktop: `grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20 items-center`
  - Left column: Headline + explainer text
  - Right column: Form or success state

**Left column content:**
- H2 heading: "Hear it yourself" — white text, bold, large (use `text-[clamp(32px,5vw,48px)] font-bold leading-[1.1] tracking-tight text-white`)
- Paragraph: "Receive a live call from our agent and discover how it transforms your firm's intake." — `text-white/70` for muted contrast

**Right column — form state (idle/submitting/error):**
- Wrap in AnimatePresence mode="wait" for form <-> success swap
- Form with key="form" inside motion.div with opacity fade
- No card container — fields sit directly on the dark background (per CONTEXT.md)
- Three stacked fields (single column):
  - Name: `<input type="text" placeholder="Your name" />` — white background, dark text
  - Phone: `<input type="tel" placeholder="(555) 123-4567" />` — white background, with auto-format
  - Email: `<input type="email" placeholder="Email address" />` — white background
- Input styling: `w-full px-4 py-3 rounded-lg bg-white text-gray-900 placeholder:text-gray-400 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/40 transition`
- Field error: `{fieldErrors.phone && <p className="text-red-400 text-sm mt-1">{fieldErrors.phone}</p>}` below each field
- Global error (429, 500): `{globalError && <p className="text-red-400 text-sm mt-3">{globalError}</p>}` above or below the button
- Submit button: `w-full py-3 rounded-lg font-semibold text-lg transition` — use a bright accent color (white bg with dark navy text for contrast on the dark section, or a contrasting accent). Use `bg-white text-[#00122e] hover:bg-white/90` for the button. Show Loader2 spinner with `animate-spin` when submitting.
- Button text: "Get a call" (per CONTEXT.md)
- Consent line below button: `<p className="text-white/40 text-xs mt-3">By submitting, you agree to receive an AI-powered phone call</p>`
- Space between fields: `space-y-4` on the form container

**Right column — success state:**
- motion.div with key="success", initial opacity 0 + y:16, animate opacity 1 + y:0
- CheckCircle icon from lucide-react: `className="w-12 h-12 text-emerald-400 mb-4"` (green checkmark for success)
- Heading: `<p className="text-white text-2xl font-semibold mb-2">Your call is on its way</p>`
- Subtext: brief supporting line, e.g. `<p className="text-white/60 mb-6">You'll receive a call shortly from our AI intake specialist.</p>`
- CTA: `<Link href="/contact-sales" className="inline-block px-6 py-3 rounded-lg bg-white text-[#00122e] font-semibold hover:bg-white/90 transition">Book a sales call</Link>`

**Accessibility:**
- All inputs have associated labels (use `aria-label` or visible labels — since design is minimal with placeholders, use `aria-label` on each input)
- Form has `role="form"` and `aria-label="Demo call request"`
- Button has `aria-busy={formState === 'submitting'}`
- Error messages use `role="alert"` for screen reader announcement

**Export:** Named export `export function DemoForm()`
  </action>
  <verify>
    Run `npx tsc --noEmit` — DemoForm.tsx has no type errors.
    Run `npx eslint components/sections/DemoForm.tsx` — no lint errors (ignore pre-existing warnings in other files).
    Confirm the file exports `DemoForm` function.
    Confirm the file uses 'use client' directive.
    Confirm the file contains: useState, useReCaptcha, AsYouType, AnimatePresence, fetch('/api/demo-call'), executeRecaptcha.
  </verify>
  <done>
    DemoForm.tsx exists at components/sections/DemoForm.tsx, exports DemoForm, type-checks cleanly, and implements all four form states (idle/submitting/success/error) with phone auto-format, reCAPTCHA v3 integration, and status-code-driven error handling.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with zero errors
2. `npx tsc --noEmit` passes
3. `npm ls next-recaptcha-v3` shows installed package
4. `app/layout.tsx` contains ReCaptchaProvider wrapping LayoutWrapper
5. `components/sections/DemoForm.tsx` exists with named export DemoForm
6. DemoForm.tsx contains: FormState type, useReCaptcha hook, AsYouType formatter, AnimatePresence swap, fetch to /api/demo-call, isSubmitting ref guard
</verification>

<success_criteria>
- next-recaptcha-v3 installed and ReCaptchaProvider in layout.tsx
- DemoForm.tsx builds and type-checks with all four form states
- Phone input auto-formats as (XXX) XXX-XXXX
- reCAPTCHA token generated at submit time (not mount)
- Error handling distinguishes 429 rate limit from 400 validation from 500 server error
- Double-submit prevented by both disabled button and useRef guard
- Build passes (`npm run build` exits 0)
</success_criteria>

<output>
After completion, create `.planning/phases/04-form-ui/04-01-SUMMARY.md`
</output>
