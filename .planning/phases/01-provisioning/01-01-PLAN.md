---
phase: "01-provisioning"
plan: "01"
type: "execute"
wave: 1
depends_on: []
files_modified: ["package.json", "lib/retell/client.ts", "scripts/setup-retell.ts"]
autonomous: false
requirements: ["INFR-01", "INFR-02"]
must_haves:
  truths: ["Running npm run setup:retell with only RETELL_API_KEY set creates the LLM, agent, and phone number and writes their IDs to .env.local", "Running the script a second time does not create duplicate resources (idempotent)", "The Retell client singleton is importable in any server-side file and uses the env var (never a hardcoded key)"]
  artifacts: [{"path": "lib/retell/client.ts", "provides": "Retell SDK singleton for server-side use", "exports": ["retell"], "contains": "new Retell"}, {"path": "scripts/setup-retell.ts", "provides": "Provisioning script for LLM, agent, and phone number", "min_lines": 100, "contains": "ensureLlm"}, {"path": "package.json", "provides": "setup:retell npm script", "contains": "setup:retell"}]
  key_links: [{"from": "scripts/setup-retell.ts", "to": "retell-sdk", "via": "import Retell from retell-sdk", "pattern": "import Retell from .retell-sdk."}, {"from": "scripts/setup-retell.ts", "to": ".env.local", "via": "fs.writeFileSync to merge IDs", "pattern": "writeFileSync"}, {"from": "lib/retell/client.ts", "to": "process.env.RETELL_API_KEY", "via": "env var read at module load", "pattern": "process.env.RETELL_API_KEY"}]
user_setup: [{"service": "retell", "why": "Retell AI provides the voice agent platform - API key needed to provision resources", "env_vars": [{"name": "RETELL_API_KEY", "source": "Retell Dashboard (https://dashboard.retellai.com) -> Settings -> API Keys"}], "dashboard_config": []}]
---

<objective>
Provision the complete Retell stack (LLM response engine, voice agent, phone number) via a single idempotent script, and create the reusable Retell client singleton for all future server-side usage.

Purpose: Every subsequent phase depends on the Retell resource IDs this script produces. The client singleton ensures the API key is never hardcoded and is only accessible server-side.

Output: `lib/retell/client.ts` (singleton), `scripts/setup-retell.ts` (provisioning script), updated `package.json` with `setup:retell` npm script, `.env.local` with `RETELL_LLM_ID`, `RETELL_AGENT_ID`, `RETELL_PHONE_NUMBER`.
</objective>

<execution_context>
@C:/Users/DESKTOP/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/DESKTOP/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-provisioning/01-CONTEXT.md
@.planning/phases/01-provisioning/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install retell-sdk, add tsx, create Retell client singleton</name>
  <files>package.json, lib/retell/client.ts</files>
  <action>
1. Install dependencies:
   - `npm install retell-sdk`
   - `npm install --save-dev tsx` (needed to run TypeScript scripts directly; verify it is not already present)

2. Create `lib/retell/client.ts` — the Retell SDK singleton for server-side use:
   - Import `Retell` from `retell-sdk`
   - Guard: throw an error if `process.env.RETELL_API_KEY` is not set (with a clear message that this module is server-only)
   - Export a single `retell` instance: `new Retell({ apiKey: process.env.RETELL_API_KEY })`
   - This file must NEVER be imported from client-side code. The env var guard is sufficient for now; Phase 2+ can add `import 'server-only'` if desired.

3. Add npm script to `package.json`:
   - `"setup:retell": "npx tsx scripts/setup-retell.ts"`
  </action>
  <verify>
- `npm ls retell-sdk` shows retell-sdk installed
- `npm ls tsx` shows tsx installed in devDependencies
- `cat lib/retell/client.ts` shows the singleton with env var guard
- `cat package.json | grep setup:retell` shows the npm script
  </verify>
  <done>retell-sdk and tsx are installed, the Retell client singleton exists at lib/retell/client.ts with an env var guard, and package.json has the setup:retell script entry.</done>
</task>

<task type="auto">
  <name>Task 2: Create idempotent Retell provisioning script</name>
  <files>scripts/setup-retell.ts</files>
  <action>
Create `scripts/setup-retell.ts` implementing the full provisioning flow. The script must be run via `npm run setup:retell` and requires only `RETELL_API_KEY` to be set.

**Script structure:**

1. **Entry guard:** Check `process.env.RETELL_API_KEY` exists; exit with clear error if not.

2. **Instantiate client:** `new Retell({ apiKey: process.env.RETELL_API_KEY })` (do NOT import the singleton from lib/retell/client.ts — that file depends on env vars this script writes; use a local instance instead).

3. **Step 1/3 — ensureLlm(client):**
   - Call `client.llm.list()` and search for an LLM with `llm_name === 'kenstera-intake-llm'`
   - If found: log "LLM already exists" and return its `llm_id`
   - If not found: call `client.llm.create()` with these EXACT params (per RESEARCH.md locked decisions):
     - `llm_name: 'kenstera-intake-llm'`
     - `model: 'gpt-4.1'` (NOT 'gpt-4o' — deprecated on Retell)
     - `start_speaker: 'agent'` (REQUIRED field)
     - `begin_message`: A professional greeting identifying as Kenstera's AI intake specialist, offering the dual-path choice (legal matter intake OR learn about AI solutions). Keep this a placeholder that Phase 3 will refine.
     - `general_prompt`: A brief system prompt establishing the agent as a professional intake specialist — warm, confident, direct, no filler words. This is also a placeholder that Phase 3 will refine extensively.
     - `model_high_priority: false`
   - Return the `llm_id`

4. **Step 2/3 — ensureAgent(client, llmId):**
   - Call `client.agent.list()` and search for an agent with `agent_name === 'kenstera-intake-agent'`
   - If found: log "Agent already exists" and return its `agent_id`
   - If not found: call `client.agent.create()` with these EXACT params:
     - `agent_name: 'kenstera-intake-agent'`
     - `response_engine: { type: 'retell-llm', llm_id: llmId }`
     - `voice_id: '11labs-Matilda'` (professional female, warm — per user decision; tunable)
     - `voice_model: 'eleven_turbo_v2_5'`
     - `voice_temperature: 0.8`
     - `voice_speed: 1.0`
     - `language: 'en-US'`
     - `interruption_sensitivity: 0.9` (high — agent yields immediately per user decision)
     - `responsiveness: 1.0` (maximum — snappy response per user decision)
     - `enable_backchannel: false` (no filler words per user decision)
     - `normalize_for_speech: true`
     - `reminder_trigger_ms: 10000`
     - `reminder_max_count: 1`
     - Do NOT set `max_call_duration_ms` here — per STATE.md decision, this is set per-call in Phase 2
   - Return the `agent_id`

5. **Step 3/3 — ensurePhoneNumber(client, agentId):**
   - Call `client.phoneNumber.list()` and search for a number with `outbound_agent_id === agentId` (phone numbers have no name field — match by bound agent)
   - If found: log "Phone number already exists" and return its `phone_number`
   - If not found: try NYC area codes in order `[212, 646, 917, 347, 929]` (as numbers, not strings):
     - For each area code, call `client.phoneNumber.create({ area_code, outbound_agent_id: agentId, inbound_agent_id: agentId, country_code: 'US' })`
     - If it succeeds: log the number and area code, return `phone_number`
     - If it fails: log warning and try next area code
   - If all five fail: throw an error with a clear message listing all attempted area codes

6. **Write to .env.local** — use the read-parse-merge-write pattern:
   - Read existing `.env.local` if it exists (do not clobber other entries like RETELL_API_KEY)
   - Parse each line as KEY=VALUE
   - Merge/overwrite: `RETELL_LLM_ID`, `RETELL_AGENT_ID`, `RETELL_PHONE_NUMBER`
   - Write back all entries
   - Use `path.join(process.cwd(), '.env.local')` for the file path

7. **Summary output:** Print a clear summary with all three IDs and a note about Branded Caller ID being a manual dashboard step (CNAM cannot be set via API — per RESEARCH.md pitfall 4).

8. **Error handling:** Wrap `main()` in `.catch()` that logs the error and exits with code 1.

**Important constraints:**
- Use `import Retell from 'retell-sdk'` (ESM import)
- Use `import fs from 'fs'` and `import path from 'path'` (Node built-ins)
- The script runs via `npx tsx` which supports ESM in a Next.js project
- If tsx has issues with `moduleResolution: "bundler"`, the executor should add a minimal `tsconfig.scripts.json` with `"moduleResolution": "node16"` and update the npm script to `npx tsx --tsconfig tsconfig.scripts.json scripts/setup-retell.ts`
  </action>
  <verify>
- `cat scripts/setup-retell.ts` shows the complete script with all three ensure functions, env merge, and error handling
- The script compiles without type errors: `npx tsx --eval "import './scripts/setup-retell.ts'" 2>&1` (this will fail at runtime due to missing API key, but should not have import/type errors — look for TypeScript errors vs runtime errors)
- Alternatively: `npx tsc --noEmit scripts/setup-retell.ts` to type-check without executing
  </verify>
  <done>scripts/setup-retell.ts exists with ensureLlm, ensureAgent, ensurePhoneNumber functions implementing list-then-create idempotency, NYC area code fallback loop, and .env.local read-parse-merge-write. The script uses gpt-4.1 model, agent voice params match all locked decisions, and max_call_duration_ms is NOT set on the agent.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify provisioning script runs correctly</name>
  <action>Human verifies the provisioning script works end-to-end.</action>
  <what-built>
Complete Retell provisioning pipeline: retell-sdk installed, client singleton at lib/retell/client.ts, idempotent setup script at scripts/setup-retell.ts, and npm run setup:retell wired up.
  </what-built>
  <how-to-verify>
1. Ensure RETELL_API_KEY is set in your environment (or in .env.local manually before running)
2. Run: `npm run setup:retell`
3. Expected output:
   - Step 1/3: LLM created (or "already exists") with an ID
   - Step 2/3: Agent created (or "already exists") with an ID
   - Step 3/3: Phone number created with an NYC area code (or "already exists")
   - "Writing IDs to .env.local..."
   - Summary with all three IDs
   - Note about Branded Caller ID being a manual step
4. Verify .env.local contains RETELL_LLM_ID, RETELL_AGENT_ID, and RETELL_PHONE_NUMBER
5. Run `npm run setup:retell` a SECOND time — it should detect all three resources already exist and skip creation (idempotency check)
6. Optionally: check the Retell dashboard to confirm the LLM, agent, and phone number appear
  </how-to-verify>
  <verify>User confirms both runs succeeded and .env.local has correct values.</verify>
  <done>Provisioning script creates resources on first run and detects existing resources on second run without duplicates.</done>
  <resume-signal>Type "approved" if provisioning worked correctly on both runs, or describe any issues (e.g., voice quality concern, area code preference, script errors).</resume-signal>
</task>

</tasks>

<verification>
- `npm run setup:retell` succeeds with only RETELL_API_KEY set, creating all three resources
- Running the script twice produces no duplicates (idempotent)
- `.env.local` contains RETELL_LLM_ID, RETELL_AGENT_ID, RETELL_PHONE_NUMBER alongside any pre-existing entries
- `lib/retell/client.ts` exports a working singleton that throws if RETELL_API_KEY is missing
- No hardcoded API keys anywhere in the codebase
</verification>

<success_criteria>
- INFR-01: The setup script provisions Retell LLM, agent, and phone number via API using only the API key — verified by a successful first run
- INFR-02: Provisioned resource IDs are written to .env.local — verified by inspecting the file after script execution
- Idempotency: Second run creates no duplicates — verified by running script twice and checking Retell dashboard
- Client singleton: lib/retell/client.ts is importable server-side with env var guard — verified by file inspection
</success_criteria>

<output>
After completion, create `.planning/phases/01-provisioning/01-01-SUMMARY.md`
</output>
