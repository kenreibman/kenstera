---
phase: 02-secure-api-route
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: []
autonomous: false
requirements: [SEC-01, SEC-02, SEC-03, SEC-04, SEC-05]

must_haves:
  truths:
    - "curl with a valid US phone and valid reCAPTCHA token returns 200 and a Retell call is placed"
    - "curl with a non-US phone returns 400 with a descriptive error"
    - "curl with a missing or invalid reCAPTCHA token returns 401"
    - "curl sent twice within 10 minutes from the same IP returns 429 on the second request"
    - "curl sent twice within 10 minutes with the same phone returns 429 on the second request"
    - "Vercel function logs (or local console) show structured consent JSON with timestamp, IP, and phone"
  artifacts: []
  key_links: []
---

<objective>
Verify the demo-call route works end-to-end by testing every security control via curl against a running dev server. This confirms all five SEC requirements are enforced in practice, not just in code.

Purpose: The route was built in Plan 01 but has not been tested against real external services (reCAPTCHA, Upstash Redis, Retell). This checkpoint confirms the wiring is correct before Phase 3 builds the agent prompt on top of it.

Output: Human-verified confirmation that all five security controls work as specified.
</objective>

<execution_context>
@C:/Users/DESKTOP/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/DESKTOP/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-secure-api-route/02-01-SUMMARY.md
@app/api/demo-call/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify build and prepare test commands</name>
  <files></files>
  <action>
    **Step 1: Confirm required environment variables exist.**

    Check that `.env.local` contains all required variables for the route:
    - `RETELL_API_KEY` (from Phase 1)
    - `RETELL_AGENT_ID` (from Phase 1)
    - `RETELL_PHONE_NUMBER` (from Phase 1)
    - `RECAPTCHA_SECRET_KEY` (new for Phase 2 — if missing, instruct user to add it)
    - `UPSTASH_REDIS_REST_URL` (new for Phase 2 — if missing, instruct user to add it)
    - `UPSTASH_REDIS_REST_TOKEN` (new for Phase 2 — if missing, instruct user to add it)

    If any Phase 2 env vars are missing, create a checkpoint:human-action to have the user add them before proceeding. Do NOT invent placeholder values for secrets.

    **Step 2: Run production build to confirm no errors.**

    ```bash
    npm run build
    ```

    This confirms:
    - TypeScript compiles (all types resolve)
    - No server-only code leaks into the client bundle (SEC-01)
    - All imports resolve correctly

    **Step 3: Start the dev server (if not already running).**

    ```bash
    npm run dev
    ```

    Prepare the curl test commands for the human verification checkpoint. Print them to the console so the human can copy-paste.
  </action>
  <verify>
    1. `npm run build` exits with code 0
    2. All 6 required env vars are present in `.env.local`
    3. Dev server starts without errors on localhost:3000
  </verify>
  <done>
    - Production build succeeds confirming type safety and no client-bundle leakage
    - All environment variables are confirmed present
    - Dev server is running and ready for manual testing
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify all security controls via curl</name>
  <files></files>
  <action>
    Human verifies the POST /api/demo-call route built in Plan 01. The route implements five security controls:
    1. SEC-01: Retell API key server-only (never in client bundle)
    2. SEC-02: IP rate limiting (1 per 10 min sliding window via Upstash)
    3. SEC-03: Phone rate limiting (1 per 10 min sliding window via Upstash)
    4. SEC-04: Call duration capped at 180 seconds via agent_override
    5. SEC-05: Consent timestamp + IP logged to stdout

    Run these curl commands against http://localhost:3000 (dev server must be running):

    **Test 1: Non-US phone number -> expect 400**
    ```bash
    curl -s -X POST http://localhost:3000/api/demo-call \
      -H "Content-Type: application/json" \
      -d '{"phone":"+447911123456","recaptchaToken":"test"}' | jq .
    ```
    Expected: `{ "success": false, "error": "Please enter a valid US phone number." }` with HTTP 400

    **Test 2: Missing reCAPTCHA token -> expect 400**
    ```bash
    curl -s -X POST http://localhost:3000/api/demo-call \
      -H "Content-Type: application/json" \
      -d '{"phone":"+12125551234"}' | jq .
    ```
    Expected: `{ "success": false, "error": "Missing required fields." }` with HTTP 400

    **Test 3: Valid US phone + valid reCAPTCHA token -> expect 200 + real call**
    (Use Google test secret key `6LeIxAcTAAAAAGG-vFI1TnRWxMZNFuojJ4WifJWe` for RECAPTCHA_SECRET_KEY — always returns success+score=1.0)
    ```bash
    curl -s -X POST http://localhost:3000/api/demo-call \
      -H "Content-Type: application/json" \
      -d '{"phone":"+1YOUR_REAL_PHONE","recaptchaToken":"any-token-works-with-test-key"}' | jq .
    ```
    Expected: `{ "success": true }` with HTTP 200. Your phone should ring within 10 seconds.

    **Test 4: Same request again immediately -> expect 429 (IP rate limit)**
    ```bash
    curl -s -X POST http://localhost:3000/api/demo-call \
      -H "Content-Type: application/json" \
      -d '{"phone":"+1DIFFERENT_NUMBER","recaptchaToken":"any-token"}' | jq .
    ```
    Expected: `{ "success": false, "error": "Too many requests from your location. Try again in 10 minutes.", "retryAfter": ... }` with HTTP 429

    **Test 5: Check console/terminal for consent log**
    Look in the terminal running `npm run dev` for a log line like:
    ```
    [Demo Call] Consent logged: {"timestamp":"2026-02-21T...","ip":"127.0.0.1","phone":"+1...","recaptchaScore":1}
    ```

    **Test 6: Verify SEC-01 (API key not in client bundle)**
    ```bash
    npm run build
    grep -r "RETELL_API_KEY" .next/static/ 2>/dev/null || echo "PASS: RETELL_API_KEY not found in client bundle"
    ```
    Expected: "PASS: RETELL_API_KEY not found in client bundle"
  </action>
  <verify>
    Checklist:
    - [ ] Test 1: Non-US phone returns 400
    - [ ] Test 2: Missing token returns 400
    - [ ] Test 3: Valid request returns 200 and phone rings
    - [ ] Test 4: Second request returns 429
    - [ ] Test 5: Consent log visible in terminal
    - [ ] Test 6: RETELL_API_KEY not in .next/static/
  </verify>
  <done>
    Human confirms all 6 tests pass. Type "approved" if all pass, or describe which tests failed and what the actual response was.
  </done>
</task>

</tasks>

<verification>
All five SEC requirements verified through direct testing:
- SEC-01: grep confirms API key absent from client bundle
- SEC-02: Second request from same IP returns 429
- SEC-03: Second request with same phone returns 429 (tested via different IP or after IP limit reset)
- SEC-04: Retell call created with 180s cap (verified by call auto-terminating at 3 min if left running)
- SEC-05: Console output contains structured consent JSON
</verification>

<success_criteria>
- Human confirms all 6 test commands produce expected results
- A real phone call was placed and received
- Rate limiting blocked the second attempt
- No API key leakage in client bundle
</success_criteria>

<output>
After completion, create `.planning/phases/02-secure-api-route/02-02-SUMMARY.md`
</output>
